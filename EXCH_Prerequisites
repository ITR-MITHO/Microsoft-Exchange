<#
Automatically configures the below settings: 

Pagefile configuration based on installed RAM and Exchange version
TCPKeepAlive - 20 minutes
Power Plan - High Performance
IPv6 enabled on all NIC
TLS settings according to Microsofts healthchecker script

#>

# Pagefile


$RAM = (Get-WmiObject -Class Win32_ComputerSystem).TotalPhysicalMemory / 1MB
function Set-PageFile-Exchange2013_2016 {
    if ($RAM -le 8192) {
        $PageFileSize = 8202
    } elseif ($RAM -le 16384) {
        $PageFileSize = 16394
    } elseif ($RAM -le 32768) {
        $PageFileSize = 32778
    } elseif ($RAM -le 65536) {
        $PageFileSize = 32778
    } elseif ($RAM -le 131072) {
        $PageFileSize = 32778
    } elseif ($RAM -le 196608) {
        $PageFileSize = 32778
    }
    

    Set-PageFile -InitialSize $PageFileSize -MaximumSize $PageFileSize
}

function Set-PageFile-Exchange2019 {
    if ($RAM -le 65536) {
        $PageFileSize = 16384
    } elseif ($RAM -le 98304) {
        $PageFileSize = 24576
    } elseif ($RAM -le 131072) {
        $PageFileSize = 32768
    } elseif ($RAM -le 163840) {
        $PageFileSize = 40960
    } elseif ($RAM -le 196608) {
        $PageFileSize = 49152
    } elseif ($RAM -le 262144) {
        $PageFileSize = 65536
    }
    
    Set-PageFile -InitialSize $PageFileSize -MaximumSize $PageFileSize
}

function Set-PageFile {
    param (
        [int]$InitialSize,
        [int]$MaximumSize
    )
    
    $pagefileSetting = Get-WmiObject -Query "Select * from Win32_ComputerSystem"
    $pagefileSetting.AutomaticManagedPagefile = $false
    $pagefileSetting.Put()

    $pagefile = Get-WmiObject -Query "Select * from Win32_PageFileSetting where Name = 'C:\\pagefile.sys'"
    if ($pagefile -eq $null) {
        # If the pagefile does not exist, create it
        $pagefile = ([WmiClass] "root\cimv2:Win32_PageFileSetting").CreateInstance()
        $pagefile.Name = "C:\\pagefile.sys"
    }
    
    $pagefile.InitialSize = $InitialSize
    $pagefile.MaximumSize = $MaximumSize
    $pagefile.Put()

    # Verify pagefile size
}


$ExchangeVersion = Read-Host "Enter Exchange version - e.g. '2016' or '2019'"

if ($ExchangeVersion -EQ "2016") {
    Set-PageFile-Exchange2013_2016 | Out-Null
} elseif ($ExchangeVersion -EQ "2019") {
    Set-PageFile-Exchange2019 | Out-Null
} else {
    Write-Output "Unsupported Exchange version"
}

# TCPKeepAlive (20 minutes)
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\TcpIp\Parameters" -Name "KeepAliveTime" -PropertyType DWORD -Value 1200000 -Force | Out-Null

# High Performance Power Plan
powercfg -setactive SCHEME_MIN

# Enable IPV6 on all NIC
$NIC = Get-NetAdapterBinding -ComponentID ms_tcpip6 | Select Name
Foreach ($N in $NIC)

{
	$Name = $N.Name
	Enable-NetAdapterBinding -Name $Name -ComponentID ms_tcpip6
}

cmd /c "powershell iex (irm alitajran.com/wp-content/uploads/scripts/Set-ExchangeTLS.ps1)" | Out-Null

$PageSize = (Get-CimInstance Win32_PageFileSetting).MaximumSize

Write-Host "
Adjusted the following settings!

Exchange Server $ExchangeVersion
PageFile: $PageSize MB
TCPKeepAlive: 20 minutes
Power Plan: High performance
IPv6: ENABLED
TLS 1.2 Enabled (Also for 4.X and 3.5 .NET)
TLS 1.3 Disabled
TLS 1.1 Disabled
TLS 1.0 Disabled" -ForegroundColor Yellow

Write-Host "Opening Microsoft Prerequisite and ISO-download pages in 15 seconds" -ForegroundColor Green
Sleep 15
Start https://learn.microsoft.com/en-us/exchange/new-features/build-numbers-and-release-dates?view=exchserver-2019#exchange-server-2019
Start https://learn.microsoft.com/en-us/exchange/plan-and-deploy/prerequisites?view=exchserver-2019#windows-server-2019--windows-server-2022-prerequisites-for-exchange-2019
